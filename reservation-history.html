<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Reservation History</title>

  <!-- Bootstrap for Mobile-first, and JQuery -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.css" />
</head>

<body>
  <div class="container" id="restaurant-history"></div>

  <!----------------------------------------------->
  <!-- JS: Boostrap, Firebase, API related    -->
  <!----------------------------------------------->
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
  </script>

  <!-- Firebase libraries from CDN -->
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
  <!-- <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script> -->
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>

  <script src="temp/firebase-api-tempE.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
  <!--------------------------------------------------------------------->
  <!-- JS files: Your own JavaScript functions included here    -->
  <!--------------------------------------------------------------------->
  <script>
    function generateJumbotron(contID, reserID, dateText, timeText, restName, restAdd) {
      let heading = $("<h1>").attr({
        class: "display-5",
      }).text(reserID);
      let info1 = $("<p>").attr({
        class: "lead"
      }).text(dateText);
      let info2 = $("<p>").attr({
        class: "lead"
      }).text(timeText);
      let info3 = $("<p>").attr({
        class: "lead"
      }).text(restName);
      let info4 = $("<p>").attr({
        class: "lead"
      }).text(restAdd);

      let jumbo = $("<div>").attr({
        class: "jumbotron jumbotron-fluid",
        id: contID
      });
      let div = $("<div>").attr({
        class: "container",
        id: reserID
      })
      return $("#restaurant-history").append(jumbo.append(div.append(heading, info1, info2, info3, info4)));
    }

    function generateList(tagID, tableList) {
      let newList = $("<ul>").attr({
        class: "list-group"
      });

      let listItem = $("<li>").attr({
        class: "list-group-item"
      });

      tableList.forEach(function(item) {
        newList.append(listItem.clone().text(item));
      }); 

      return tagID.after(newList);
    }

    function generateState(value) {
      let text;
      if (value < 0) {
        text = "Overdue";
      } else if (value === 0) {
        text = "Completed";
      } else {
        text = "In Progress";
      }
      return $("<p>").attr({
        class: "lead"
      }).text(text);
    }

    function generateHistory() {
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          console.log("User exists");
          let count = 0;
          db.collection("users").doc(user.uid).collection("reservations")
            .get()
            .then(function(snap) {
              snap.forEach(function (doc) {
                console.log(doc.id, " -> ", doc.data());
                let contID = `container${count}`;
                let reserID = `reservation${count + 1}`;
                count++;
                let dateText = doc.data().app_date;
                let timeText = doc.data().app_time;
                let restName = doc.data().rest_name;
                let restAdd = doc.data().rest_add;
                let tableList = doc.data().tables;
                let value = doc.data().state;
                generateJumbotron(contID, reserID, dateText, timeText, restName, restAdd);
                generateList($("#" + reserID), tableList);
                $("#" + reserID).append(generateState(value));
              });
            });
        } else {
          console.log("No user");
        }
      });
    }
    generateHistory();

    // function generateReservationHistory() {
    //   let userInfo = db.collection("users").doc(user.uid).get();
    //   let reserveInfo = userInfo.collection("reservations").get();
    //   db.collection("users").doc(user.uid)
    //     .get()
    //     .then(function (snap) {
    //       snap.forEach(function(doc) {

    //       })
    //     })
    // }
  </script>
</body>

</html>